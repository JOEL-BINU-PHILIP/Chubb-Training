import java.text.NumberFormat;
import java.util.Locale;
import java.util.Map;
import java.util.Scanner;
import java.util.Set;

/**
 * Main application class for the Big Boy Toys Billing System.
 * This class runs the menu-driven console application.
 * Requirements: Menu-driven console program, Display neat billing summary
 */
public class BillingApp {

    private static DataRepository repository = new DataRepository();
    private static Scanner scanner = new Scanner(System.in);
    // Formatter for USD currency, as seen in the prompt
    private static NumberFormat currencyFormatter = NumberFormat.getCurrencyInstance(Locale.US);

    public static void main(String[] args) {
        System.out.println("==============================================");
        System.out.println("Welcome to Big Boy Toys Billing");
        System.out.println("==============================================");

        // 1. Select Brand
        String brand = selectBrand();

        // 2. Select Model
        String model = selectModel(brand);

        // 3. Get Price
        double exShowroomPrice = repository.getPrice(brand, model);

        // 4. Create Vehicle object (Demonstrates Runtime Polymorphism)
        Vehicle selectedCar = new LuxuryCar(brand, model, exShowroomPrice);

        // 5. Select Insurance
        boolean addThirdParty = selectInsurance();

        // 6. Calculate all costs
        OnRoadPriceBreakdown breakdown = selectedCar.calculateOnRoadPrice();
        Insurance insurance = selectedCar.calculateInsurance(addThirdParty);
        double totalPayable = breakdown.getTotalOnRoadPrice() + insurance.getTotalInsuranceCost();

        // 7. Display Bill
        displayBill(selectedCar, breakdown, insurance, totalPayable);

        scanner.close();
    }

    /**
     * Displays the brand menu and gets a valid selection.
     */
    private static String selectBrand() {
        System.out.println("\nPlease select a car brand:");
        Set<String> brands = repository.getBrands();
        String[] brandArray = brands.toArray(new String[0]);
        
        for (int i = 0; i < brandArray.length; i++) {
            System.out.printf("%d. %s\n", i + 1, brandArray[i]);
        }

        int choice = getValidatedIntInput(1, brandArray.length) - 1;
        return brandArray[choice];
    }

    /**
     * Displays the model menu for the chosen brand and gets a valid selection.
     */
    private static String selectModel(String brand) {
        System.out.printf("\nPlease select a model for %s:\n", brand);
        Map<String, Double> models = repository.getModelsForBrand(brand);
        String[] modelArray = models.keySet().toArray(new String[0]);
        
        for (int i = 0; i < modelArray.length; i++) {
            double price = models.get(modelArray[i]);
            System.out.printf("%d. %s (%s)\n", i + 1, modelArray[i], currencyFormatter.format(price));
        }

        int choice = getValidatedIntInput(1, modelArray.length) - 1;
        return modelArray[choice];
    }

    /**
     * Prompts the user to select an insurance plan.
     */
    private static boolean selectInsurance() {
        System.out.println("\n--- Insurance Selection ---");
        System.out.println("Plan 1: Comprehensive Only");
        System.out.println("Plan 2: Comprehensive + 5-Year Third-Party");
        System.out.print("Do you want to add the 5-Year Third-Party plan? (yes/no): ");
        
        while (true) {
            String input = scanner.nextLine().trim().toLowerCase();
            if (input.equals("yes") || input.equals("y")) {
                return true;
            } else if (input.equals("no") || input.equals("n")) {
                return false;
            } else {
                System.out.print("Invalid input. Please enter 'yes' or 'no': ");
            }
        }
    }

    /**
     * Displays the final neat billing summary.
     */
    private static void displayBill(Vehicle car, OnRoadPriceBreakdown breakdown, Insurance insurance, double totalPayable) {
        System.out.println("\n==============================================");
        System.out.println("           FINAL INVOICE - Big Boy Toys");
        System.out.println("==============================================");
        
        System.out.println("\n--- Car Details ---");
        System.out.printf("Brand:          %s\n", car.getBrand());
        System.out.printf("Model:          %s\n", car.getModel());
        System.out.printf("Ex-Showroom:    %s\n", currencyFormatter.format(car.getExShowroomPrice()));

        System.out.println("\n--- On-Road Price Calculation ---");
        System.out.printf("Ex-Showroom Price:       %s\n", currencyFormatter.format(breakdown.getExShowroomPrice()));
        System.out.printf("+ Luxury Tax (20%%):        %s\n", currencyFormatter.format(breakdown.getLuxuryTax()));
        System.out.printf("+ Import Duty (60%%):       %s\n", currencyFormatter.format(breakdown.getImportDuty()));
        System.out.printf("+ GST (40%%):               %s\n", currencyFormatter.format(breakdown.getGst()));
        System.out.printf("----------------------------------------------\n");
        System.out.printf("Total On-Road Price:     %s\n", currencyFormatter.format(breakdown.getTotalOnRoadPrice()));

        System.out.println("\n--- Insurance Details ---");
        System.out.printf("Selected Plan:  %s\n", insurance.getPlanName());
        System.out.printf("Comprehensive (10%%):     %s\n", currencyFormatter.format(insurance.getComprehensiveCost()));
        
        if (insurance.isThirdPartyIncluded()) {
            System.out.printf("+ 5-Year Third-Party (5%%): %s\n", currencyFormatter.format(insurance.getThirdPartyCost()));
            System.out.printf("+ No Claim Bonus (20%%):  %s\n", currencyFormatter.format(insurance.getNoClaimBonusCharge()));
            System.out.printf("+ GST on Ex-Showroom (18%%): %s\n", currencyFormatter.format(insurance.getGstCharge()));
        }
        System.out.printf("----------------------------------------------\n");
        System.out.printf("Total Insurance Cost:    %s\n", currencyFormatter.format(insurance.getTotalInsuranceCost()));
        
        System.out.println("\n==============================================");
        System.out.printf("  FINAL PAYABLE AMOUNT: %s\n", currencyFormatter.format(totalPayable));
        System.out.println("==============================================");
    }

    /**
     * Helper utility for getting a validated integer input from the user.
     */
    private static int getValidatedIntInput(int min, int max) {
        int choice = -1;
        while (choice < min || choice > max) {
            System.out.printf("Enter your choice (%d-%d): ", min, max);
            try {
                choice = Integer.parseInt(scanner.nextLine());
                if (choice < min || choice > max) {
                    System.out.println("Invalid choice. Please try again.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Invalid input. Please enter a number.");
            }
        }
        return choice;
    }
}