import java.text.NumberFormat;
import java.util.*;


// Main application class for the Big Boy Toys Billing System.
 

public class BillingApp {

    private static CarData repo = new CarData();
    private static Scanner scanner = new Scanner(System.in);
    private static NumberFormat currencyFormatter = NumberFormat.getCurrencyInstance(Locale.US);

    public static void main(String[] args) {
        System.out.println("==============================================");
        System.out.println("Welcome to Big Boy Toys Billing");
        System.out.println("==============================================");

        String brand = selectBrand();
        String modelName = selectModel(brand); 

        // Get the full model details (price + cc)
        CarModel selectedModelDetails = repo.getModel(brand, modelName);

        // Create Vehicle object, now passing all details
        Vehicle selectedCar = new LuxuryCar(brand, modelName, 
                                            selectedModelDetails.getExShowroomPrice(), 
                                            selectedModelDetails.getEngineCC());

        boolean addThirdParty = selectInsurance();

        // Calculations
        OnRoadPriceBreakdown breakdown = selectedCar.calculateOnRoadPrice();
        Insurance insurance = selectedCar.calculateInsurance(addThirdParty);
        double totalPayable = breakdown.getTotalOnRoadPrice() + insurance.getTotalInsuranceCost();

        // Display Bill
        displayBill(selectedCar, breakdown, insurance, totalPayable);

        scanner.close();
    }

    
    //  Displays the brand menu. 
     
    private static String selectBrand() {
        System.out.println("\nPlease select a car brand:");
        Set<String> brands = repo.getBrands();
        String[] brandArray = brands.toArray(new String[0]);
        
        for (int i = 0; i < brandArray.length; i++) {
            System.out.printf("%d. %s\n", i + 1, brandArray[i]);
        }

        int choice = getValidatedIntInput(1, brandArray.length) - 1;
        return brandArray[choice];
    }

   
     //  Displays the model menu. 
     // Now reads price from the CarModel object.
     
    private static String selectModel(String brand) {
        System.out.printf("\nPlease select a model for %s:\n", brand);
        
        // Map now contains <String, CarModel>
        Map<String, CarModel> models = repo.getModelsForBrand(brand);
        String[] modelArray = models.keySet().toArray(new String[0]);
        
        for (int i = 0; i < modelArray.length; i++) {
            String modelName = modelArray[i];
            // Get the CarModel object to find its price
            double price = models.get(modelName).getExShowroomPrice();
            System.out.printf("%d. %s (%s)\n", i + 1, modelName, currencyFormatter.format(price));
        }

        int choice = getValidatedIntInput(1, modelArray.length) - 1;
        return modelArray[choice];
    }

    
    //  This function is there for the user to choose which insurance plan he wants. 
     
    private static boolean selectInsurance() {
        System.out.println("\n--- Insurance Selection ---");
        System.out.println("Plan 1: Comprehensive Only");
        System.out.println("Plan 2: Comprehensive + 5-Year Third-Party");
        System.out.print("Do you want to add the 5-Year Third-Party plan? (yes/no): ");
        
        while (true) {
            String input = scanner.nextLine().trim().toLowerCase();
            if (input.equals("yes") || input.equals("y")) {
                return true;
            } else if (input.equals("no") || input.equals("n")) {
                return false;
            } else {
                System.out.print("Invalid input. Please enter 'yes' or 'no': ");
            }
        }
    }

    
     // Displays the final neat billing summary. 
    private static void displayBill(Vehicle car, OnRoadPriceBreakdown breakdown, Insurance insurance, double totalPayable) {
        System.out.println("\n==============================================");
        System.out.println("           FINAL INVOICE - Big Boy Toys");
        System.out.println("==============================================");
        
        System.out.println("\n--- Car Details ---");
        System.out.printf("Brand:          %s\n", car.getBrand());
        System.out.printf("Model:          %s\n", car.getModel());
        System.out.printf("Engine:         %dcc\n", car.getEngineCC()); 
        System.out.printf("Ex-Showroom:    %s\n", currencyFormatter.format(car.getExShowroomPrice()));

        System.out.println("\n--- On-Road Price Calculation ---");
        System.out.printf("Ex-Showroom Price:       %s\n", currencyFormatter.format(breakdown.getExShowroomPrice()));
        System.out.printf("+ Luxury Tax (20%% at 6750cc): %s\n", currencyFormatter.format(breakdown.getLuxuryTax())); 
        System.out.printf("+ Import Duty (60%%):       %s\n", currencyFormatter.format(breakdown.getImportDuty()));
        System.out.printf("+ GST (40%%):               %s\n", currencyFormatter.format(breakdown.getGst()));
        System.out.printf("----------------------------------------------\n");
        System.out.printf("Total On-Road Price:     %s\n", currencyFormatter.format(breakdown.getTotalOnRoadPrice()));

        System.out.println("\n--- Insurance Details ---");
        System.out.printf("Selected Plan:  %s\n", insurance.getPlanName());
        System.out.printf("Comprehensive (10%%):     %s\n", currencyFormatter.format(insurance.getComprehensiveCost()));
        
        if (insurance.isThirdPartyIncluded()) {
            System.out.printf("+ 5-Year Third-Party (5%%): %s\n", currencyFormatter.format(insurance.getThirdPartyCost()));
            System.out.printf("+ No Claim Bonus (20%%):  %s\n", currencyFormatter.format(insurance.getNoClaimBonusCharge()));
            System.out.printf("+ GST on Ex-Showroom (18%%): %s\n", currencyFormatter.format(insurance.getGstCharge()));
        }
        System.out.printf("----------------------------------------------\n");
        System.out.printf("Total Insurance Cost:    %s\n", currencyFormatter.format(insurance.getTotalInsuranceCost()));
        
        System.out.println("\n==============================================");
        System.out.printf("  FINAL PAYABLE AMOUNT: %s\n", currencyFormatter.format(totalPayable));
        System.out.println("==============================================");
    }

    
     // Helper function for input validation. 
     
    private static int getValidatedIntInput(int min, int max) {
        int choice = -1;
        while (choice < min || choice > max) {
            System.out.printf("Enter your choice (%d-%d): ", min, max);
            try {
                choice = Integer.parseInt(scanner.nextLine());
                if (choice < min || choice > max) {
                    System.out.println("Invalid choice. Please try again.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Invalid input. Please enter a number.");
            }
        }
        return choice;
    }
}